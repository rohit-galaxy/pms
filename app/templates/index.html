<!DOCTYPE html>
<html lang="ta">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Product Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="">
    <div class="container mt-3">
        <h2 class="mb-0">Products</h2>
        <button class="btn btn-primary" id="btnAdd">Add Product</button>

      <table id="productTable" class="table table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Category</th>
            <th>Brand</th>
            <th>Image</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for p in products %}
          <tr data-id="{{ p.id }}">
            <td>{{ p.id }}</td>
            <td>{{ p.name }}</td>
            <td>{{ p.category_name }}</td>
            <td>{{ p.brand_name }}</td>
            <td>
              {% if p.image_path %}
              <img
                src="{{ url_for('static', filename='uploads/' ~ p.image_path) }}"
                width="50"
              />
              {% else %} - {% endif %}
            </td>
            <td>
              <button class="btn btn-sm btn-info btn-edit">Edit</button>
              <button class="btn btn-sm btn-danger btn-delete">Delete</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
      <div class="modal-dialog">
        <form id="productForm" enctype="multipart/form-data">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitle">Add Product</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="productId" name="productId" />
              <div class="mb-3">
                <label for="name" class="form-label">Product Name</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="category" class="form-label">Category</label>
                <select
                  id="category"
                  name="category_id"
                  class="form-select"
                  required
                >
                  <option value="">Select Category</option>
                  {% for c in categories %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="brand" class="form-label">Brand</label>
                <select id="brand" name="brand_id" class="form-select" required>
                  <option value="">Select Brand</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="image" class="form-label">Image (optional)</label>
                <input
                  type="file"
                  name="image"
                  id="image"
                  class="form-control"
                  accept=".png,.jpg,.jpeg"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button type="submit" class="btn btn-primary" id="saveBtn">
                Save
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      $(function () {
        let modal = new bootstrap.Modal($("#productModal")[0]);
        let table = $("#productTable").DataTable();
        $("#category, #brand").select2({
          dropdownParent: $("#productModal"),
          width: "100%",
        });

        // Load brands dynamically
        $("#category").on("change", function () {
          let categoryId = $(this).val();
          if (!categoryId) {
            $("#brand")
              .html('<option value="">Select Brand</option>')
              .trigger("change");
            return;
          }
          $.getJSON("/brands/" + categoryId, function (data) {
            let options = '<option value="">Select Brand</option>';
            $.each(data, function (i, brand) {
              options += `<option value="${brand.id}">${brand.name}</option>`;
            });
            $("#brand").html(options).trigger("change");
          });
        });

        $("#btnAdd").click(function () {
          $("#modalTitle").text("Add Product");
          $("#productForm")[0].reset();
          $("#productId").val("");
          $("#brand")
            .html('<option value="">Select Brand</option>')
            .trigger("change");
          modal.show();
        });

        // Edit button click
        $("#productTable").on("click", ".btn-edit", function () {
          let tr = $(this).closest("tr");
          let id = tr.data("id");
          $.getJSON(`/product/get/${id}`, function (data) {
            $("#modalTitle").text("Edit Product");
            $("#productId").val(data.id);
            $("#name").val(data.name);
            $("#category").val(data.category_id).trigger("change");
            // Load brands and set selection
            $.getJSON("/brands/" + data.category_id, function (brands) {
              let options = '<option value="">Select Brand</option>';
              $.each(brands, function (i, brand) {
                options += `<option value="${brand.id}">${brand.name}</option>`;
              });
              $("#brand").html(options);
              $("#brand").val(data.brand_id).trigger("change");
              modal.show();
            });
          });
        });

        // Delete button click
        $("#productTable").on("click", ".btn-delete", function () {
          if (!confirm("Are you sure you want to delete this product?")) return;
          let tr = $(this).closest("tr");
          let id = tr.data("id");
          $.post(`/product/delete/${id}`, function (res) {
            if (res.success) {
              table.row(tr).remove().draw();
              showToast(res.message, "bg-success");
            } else {
              showToast("Delete failed", "bg-danger");
            }
          });
        });

        // Submit add/edit form
        $("#productForm").submit(function (e) {
          e.preventDefault();
          let id = $("#productId").val();
          let url = id ? `/product/update/${id}` : "/product/create";
          let formData = new FormData(this);

          $.ajax({
            url: url,
            method: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: function (res) {
              if (res.success) {
                showToast(res.message, "bg-success");
                modal.hide();
                setTimeout(() => location.reload(), 800);
              } else {
                showToast(res.message, "bg-danger");
              }
            },
            error: function () {
              showToast("Server error occurred", "bg-danger");
            },
          });
        });

        // Toast helper
        function showToast(message, className) {
          let toastHtml = `
    <div class="toast align-items-center text-white ${className} border-0 show position-fixed top-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`;
          let $toast = $(toastHtml);
          $("body").append($toast);
          setTimeout(() => $toast.fadeOut(400, () => $toast.remove()), 3500);
        }
      });
    </script>
  </body>
</html>
