{% extends "base.html" %}
{% block title %}Change Password{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-5">
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        <h4 class="mb-3">Change Password</h4>
        <form id="changePasswordForm" novalidate>
          <div class="mb-3">
            <label for="old_password" class="form-label">Old Password</label>
            <input type="password" id="old_password" name="old_password" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="new_password" class="form-label">New Password</label>
            <input type="password" id="new_password" name="new_password" class="form-control" required minlength="6">
          </div>
          <div class="mb-3">
            <label for="confirm_password" class="form-label">Confirm New Password</label>
            <input type="password" id="confirm_password" name="confirm_password" class="form-control" required equalTo="#new_password">
          </div>
          <button class="btn btn-primary w-100" type="submit">Update Password</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
<script>
$(function () {
  var validator = $("#changePasswordForm").validate({
    rules: {
      old_password: {
        required: true,
        remote: {
          url: "/auth/validate-old-password",
          type: "POST",
          data: {
            old_password: function () {
              return $("#old_password").val();
            }
          },
          dataFilter: function(response) {
            var res = JSON.parse(response);
            // jQuery validate: "true" string means pass, any other string is the error message
            return res.valid ? "true" : "\"Old password is incorrect.\"";
          }
        }
      },
      new_password: { required: true, minlength: 6 },
      confirm_password: { required: true, equalTo: "#new_password" }
    },
    messages: {
      old_password: {
        required: "Please enter your old password",
        remote: "Old password is incorrect."
      },
      new_password: {
        required: "Please enter a new password",
        minlength: "Password must be at least 6 characters"
      },
      confirm_password: {
        required: "Please confirm the new password",
        equalTo: "Passwords do not match"
      }
    },
    errorElement: "div",
    errorClass: "text-danger mt-1",
    highlight: function (el) { $(el).addClass("is-invalid"); },
    unhighlight: function (el) { $(el).removeClass("is-invalid"); },
    errorPlacement: function (error, element) { error.insertAfter(element); },
    submitHandler: function (form) {
      const formData = $(form).serialize();
      $.ajax({
        url: "/users/change-password",
        method: "POST",
        data: formData,
        success: function (res) {
          if (res.success) {
            validator.resetForm();
            form.reset();
            showToast(res.message || "Password updated successfully", "bg-success");
          } else {
            // Put any additional backend error under old_password field
            validator.showErrors({
              old_password: res.message || "Password update failed"
            });
          }
        },
        error: function (xhr) {
          try {
            let res = JSON.parse(xhr.responseText);
            if (
              res.message &&
              (
                res.message.toLowerCase().includes('old password is incorrect') ||
                res.message.toLowerCase().includes('old password')
              )
            ) {
              validator.showErrors({
                old_password: res.message
              });
            } else if (
              res.message &&
              res.message.toLowerCase().includes('passwords do not match')
            ) {
              validator.showErrors({
                confirm_password: res.message
              });
            } else {
              validator.showErrors({
                old_password: res.message || "Password update failed"
              });
            }
          } catch {
            validator.showErrors({
              old_password: "Password update failed"
            });
          }
        }
      });
      return false;
    }
  });

  // Only used for success
  function showToast(message, className) {
    let toastHtml = `
      <div class="toast align-items-center text-white ${className} border-0 show position-fixed top-0 end-0 m-3"
           role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>`;
    $("body").append(toastHtml);
    setTimeout(() => $(".toast").fadeOut(400, function () { $(this).remove(); }), 3500);
  }
});
</script>
{% endblock %}
